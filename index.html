<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>BPMN Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- bpmn-js standardstilar -->
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js/dist/assets/diagram-js.css">
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js/dist/assets/bpmn-font/css/bpmn.css">
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #app { display: grid; grid-template-columns: 1fr 320px; height: 100%; }
    #canvas { background: #fafafa; }
    #side {
      border-left: 1px solid #e5e7eb; padding: 12px; overflow: auto;
      display: flex; flex-direction: column; gap: 12px;
    }
    .el { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .k { color: #374151; font-weight: 600; }
    .v { color: #111827; }
    .highlight > .djs-outline { stroke: #ef4444 !important; stroke-width: 2px !important; }
    .highlight > .djs-visual > :nth-child(1) { stroke: #ef4444 !important; }
    .toolbar { display:flex; gap:8px; flex-wrap: wrap; }
    button { padding:6px 10px; border:1px solid #d1d5db; background:#fff; border-radius:8px; cursor:pointer; }
    input[type="text"] { width: 100%; padding:6px 10px; border:1px solid #d1d5db; border-radius:8px; }
    small { color:#6b7280; }
    a { color:#2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div id="app">
    <div id="canvas"></div>
    <aside id="side">
      <div>
        <h3 style="margin:0 0 6px 0;">BPMN Viewer</h3>
        <small>Tips: lÃ¤gg till <code>?el=&lt;elementId&gt;</code> i URL:en fÃ¶r att hoppa till och markera ett element.</small>
      </div>

      <div class="toolbar">
        <button id="btn-zoom-in">Zoom +</button>
        <button id="btn-zoom-out">Zoom âˆ’</button>
        <button id="btn-reset">Fit</button>
      </div>

      <div>
        <label for="elInput" class="k">GÃ¥ till element-ID</label>
        <input id="elInput" type="text" placeholder="t.ex. Activity_11wac6l" />
        <div class="toolbar">
          <button id="btn-go">Markera</button>
          <button id="btn-clear">Rensa markering</button>
        </div>
      </div>

      <div id="info">
        <div><span class="k">Valt element:</span> <span class="v el" id="selId">â€“</span></div>
        <div><span class="k">Typ:</span> <span class="v" id="selType">â€“</span></div>
        <div><span class="k">Namn:</span> <span class="v" id="selName">â€“</span></div>
        <hr/>
        <div><span class="k">SnabblÃ¤nkar:</span></div>
        <div id="links">
          <small>VÃ¤lj ett element fÃ¶r att generera lÃ¤nkar (Jira, Playwright, Figma) baserat pÃ¥ ID.</small>
        </div>
      </div>
    </aside>
  </div>

  <!-- bpmn-js viewer -->
  <script src="https://unpkg.com/bpmn-js/dist/bpmn-navigated-viewer.development.js"></script>
  <script>
    // === Konfiguration ===
    const RAW_BPMN_PATH = 'ci_test.bpmn'; // byt om du anvÃ¤nder annan sÃ¶kvÃ¤g
    const BPMN_PATH = new URL(RAW_BPMN_PATH, window.location.href).toString() + `?v=${Date.now()}`;

    // Repo-konfig fÃ¶r lÃ¤nkar
    const GH_OWNER = 'mangepang';
    const GH_REPO  = 'test_ci';
    const GH_BRANCH = 'main';

    // BaslÃ¤nkar
    const JIRA_BASE_QUERY = 'https://jira.example.com/issues/?jql='; // Jira-sÃ¶k (byt till er)
    const PLAYWRIGHT_CODE_SEARCH = `https://github.com/${GH_OWNER}/${GH_REPO}/search?q=`;
    const PLAYWRIGHT_FILE_BASE   = `https://github.com/${GH_OWNER}/${GH_REPO}/blob/${GH_BRANCH}/`;

    // Figma (om full URL saknas i BPMN)
    const FIGMA_FILE_KEY = 'ABCDE'; // valfritt â€“ lÃ¤mna '' om ni alltid har full figmaUrl

    const viewer = new BpmnJS({ container: '#canvas', height: '100%' });

    // ===== Helpers fÃ¶r parsing & rendering =====
    const metaById = new Map();

    const ln = (tagName) => (tagName || '').split(':').pop();
    const text = (el) => (el && (el.textContent || '').trim()) || '';
    const toList = (val) => (val || '').split(/[,|]/).map(s => s.trim()).filter(Boolean);

    function buildMetaIndex(xmlString) {
      const dom = new DOMParser().parseFromString(xmlString, 'text/xml');
      const elWithExt = dom.querySelectorAll('*[id] > bpmn\\:extensionElements, *[id] > extensionElements');

      elWithExt.forEach(ext => {
        const parent = ext.parentNode;
        const id = parent.getAttribute('id');
        if (!id) return;

        const meta = {
          playwrightRefs: [],
          jiraKeys: [],
          tags: [],
          priority: '',
          figmaUrl: '',
          figmaNodeId: '',
          figmaComponentKey: '',
          variant: ''
        };

        Array.from(ext.children || []).forEach(child => {
          Array.from(child.children || []).forEach(kv => {
            const name = ln(kv.tagName);
            const val = text(kv);

            switch (name) {
              case 'playwrightRef':    meta.playwrightRefs.push(val); break;
              case 'jiraKeys':         meta.jiraKeys.push(...toList(val)); break;
              case 'tags':             meta.tags.push(...toList(val)); break;
              case 'priority':         meta.priority = val; break;
              case 'figmaUrl':         meta.figmaUrl = val; break;
              case 'figmaNodeId':      meta.figmaNodeId = val; break;
              case 'figmaComponentKey':meta.figmaComponentKey = val; break;
              case 'variant':          meta.variant = val; break;
              default: /* ignore */ ;
            }
          });
        });

        metaById.set(id, meta);
      });
    }

    function buildFigmaUrl(meta) {
      if (meta.figmaUrl) return meta.figmaUrl;
      if (FIGMA_FILE_KEY && meta.figmaNodeId) {
        return `https://www.figma.com/file/${FIGMA_FILE_KEY}?node-id=${encodeURIComponent(meta.figmaNodeId)}`;
      }
      return '';
    }

    const getParam = (name) => new URLSearchParams(window.location.search).get(name);

    function addMarker(elementId) {
      try {
        const canvas = viewer.get('canvas');
        canvas.addMarker(elementId, 'highlight');
        canvas.zoom('fit-viewport', 'auto');
        canvas.scrollToElement(elementId);
      } catch {}
    }

    function clearMarkers() {
      const canvas = viewer.get('canvas');
      const elementRegistry = viewer.get('elementRegistry');
      elementRegistry.getAll().forEach(el => canvas.removeMarker(el.id, 'highlight'));
    }

    function setSelected(el) {
      const links = document.getElementById('links');
      const idEl = document.getElementById('selId');
      const typeEl = document.getElementById('selType');
      const nameEl = document.getElementById('selName');

      idEl.textContent   = el?.id ?? 'â€“';
      typeEl.textContent = el?.type ?? 'â€“';
      nameEl.textContent = el?.businessObject?.name ?? 'â€“';

      links.innerHTML = '';
      if (!el) {
        links.innerHTML = '<small>VÃ¤lj ett element fÃ¶r att generera lÃ¤nkar.</small>';
        return;
      }

      const elId = el.id;
      const meta = metaById.get(elId) || {};

      // --- Playwright ---
      if (meta.playwrightRefs && meta.playwrightRefs.length) {
        const h = document.createElement('div');
        h.innerHTML = '<div class="k" style="margin-top:6px;">Playwright</div>';
        links.appendChild(h);

        meta.playwrightRefs.forEach(ref => {
          // FÃ¶rvÃ¤ntat format: "tests/uc_income.spec.ts#Valid income entry"
          const [path, title] = ref.split('#');
          const safePath = (path || '').replace(/^\/+/, ''); // ta bort ev. ledande "/"
          const fileUrl = PLAYWRIGHT_FILE_BASE + encodeURI(safePath);

          const aFile = document.createElement('a');
          aFile.href = fileUrl;
          aFile.target = '_blank';
          aFile.textContent = `ðŸ“„ ${safePath}${title ? ` â€” ${title}` : ''}`;
          links.appendChild(aFile);
          links.appendChild(document.createElement('br'));
        });

        // Repo-sÃ¶k pÃ¥ "[bpmn:ID]" begrÃ¤nsat till tests/ och code
        const q = `path:tests "[bpmn:${elId}]"`;
        const codeSearch = document.createElement('a');
        codeSearch.href = `${PLAYWRIGHT_CODE_SEARCH}${encodeURIComponent(q)}&type=code`;
        codeSearch.target = '_blank';
        codeSearch.textContent = 'ðŸ”Ž SÃ¶k [bpmn:ID] i testkoden';
        links.appendChild(codeSearch);
        links.appendChild(document.createElement('br'));
      }

      // --- Jira ---
      if (meta.jiraKeys && meta.jiraKeys.length) {
        const h = document.createElement('div');
        h.innerHTML = '<div class="k" style="margin-top:6px;">Jira</div>';
        links.appendChild(h);

        meta.jiraKeys.forEach(key => {
          const a = document.createElement('a');
          a.href = `https://jira.example.com/browse/${encodeURIComponent(key)}`;
          a.target = '_blank';
          a.textContent = `ðŸ”— ${key}`;
          links.appendChild(a);
          links.appendChild(document.createElement('br'));
        });
      }

      // Jira fallback: sÃ¶k pÃ¥ ID
      const jiraSearch = document.createElement('a');
      jiraSearch.href = JIRA_BASE_QUERY + encodeURIComponent(`text ~ "${elId}" OR "BPMN Element ID" ~ "${elId}"`);
      jiraSearch.target = '_blank';
      jiraSearch.textContent = 'ðŸ”Ž SÃ¶k Ã¤renden kopplade till ID';
      links.appendChild(jiraSearch);
      links.appendChild(document.createElement('br'));

      // --- Figma ---
      const figmaResolved = buildFigmaUrl(meta);
      if (figmaResolved) {
        const h = document.createElement('div');
        h.innerHTML = '<div class="k" style="margin-top:6px;">Figma</div>';
        links.appendChild(h);

        const a = document.createElement('a');
        a.href = figmaResolved;
        a.target = '_blank';
        a.textContent = 'ðŸŽ¨ Ã–ppna relaterad Figma-skÃ¤rm';
        links.appendChild(a);
        links.appendChild(document.createElement('br'));

        if (meta.variant) {
          const v = document.createElement('div');
          v.innerHTML = `<small>Variant: <code>${meta.variant}</code></small>`;
          links.appendChild(v);
        }
      }

      // --- Badges (taggar/prio) ---
      const chips = [];
      if (meta.priority) chips.push(`Prio: ${meta.priority}`);
      if (meta.tags && meta.tags.length) chips.push(`Taggar: ${meta.tags.join(', ')}`);
      if (chips.length) {
        const c = document.createElement('div');
        c.innerHTML = `<small>${chips.join(' â€¢ ')}</small>`;
        c.style.marginTop = '6px';
        links.appendChild(c);
      }
    }

    // ===== Ladda BPMN, bygg meta, init viewer =====
    fetch(BPMN_PATH, { cache: 'no-store' })
      .then(async (r) => {
        if (!r.ok) throw new Error(`HTTP ${r.status} for ${r.url}`);
        const xml = await r.text();

        buildMetaIndex(xml);           // indexera extensionElements
        await viewer.importXML(xml);   // ladda in modellen

        const canvas = viewer.get('canvas');
        const eventBus = viewer.get('eventBus');
        const elementRegistry = viewer.get('elementRegistry');

        canvas.zoom('fit-viewport', 'auto');

        // URL-param: ?el=<elementId>
        const elParam = getParam('el');
        if (elParam) {
          const exists = elementRegistry.get(elParam);
          if (exists) {
            addMarker(elParam);
            setSelected(exists);
            document.getElementById('elInput').value = elParam;
          }
        }

        // Klick-select
        eventBus.on('element.click', (e) => {
          const { element } = e;
          clearMarkers();
          addMarker(element.id);
          setSelected(element);
          history.replaceState(null, '', `?el=${encodeURIComponent(element.id)}`);
        });

        // Knappar
        const canvasApi = viewer.get('canvas');
        document.getElementById('btn-zoom-in').onclick  = () => canvasApi.zoom(canvasApi.zoom() + 0.2);
        document.getElementById('btn-zoom-out').onclick = () => canvasApi.zoom(canvasApi.zoom() - 0.2);
        document.getElementById('btn-reset').onclick    = () => canvasApi.zoom('fit-viewport', 'auto');

        document.getElementById('btn-go').onclick = () => {
          const id = document.getElementById('elInput').value.trim();
          if (!id) return;
          const el = elementRegistry.get(id);
          if (el) {
            clearMarkers();
            addMarker(id);
            setSelected(el);
            history.replaceState(null, '', `?el=${encodeURIComponent(id)}`);
          } else {
            alert('Elementet hittades inte i modellen.');
          }
        };
        document.getElementById('btn-clear').onclick = () => {
          clearMarkers();
          setSelected(null);
          history.replaceState(null, '', location.pathname);
        };
      })
      .catch(err => {
        console.error('Fel vid laddning av BPMN:', err);
        alert(`Kunde inte ladda BPMN-filen.\n${err.message}\n\nKolla att filen finns pÃ¥:\n${RAW_BPMN_PATH}`);
      });
  </script>
</body>
</html>
