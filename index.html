<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>CI Test â€“ BPMN Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Material look: Roboto + Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:FILL@0..1" rel="stylesheet">

  <!-- bpmn-js standardstilar -->
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js/dist/assets/diagram-js.css">
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js/dist/assets/bpmn-font/css/bpmn.css">

  <style>
    :root{
      --md-surface:#ffffff;
      --md-on-surface:#1f2937;
      --md-surface-variant:#f3f4f6;
      --md-outline:#e5e7eb;
      --md-primary:#1a73e8;
      --md-danger:#ef4444;
    }
    *{box-sizing:border-box}
    html, body { height: 100%; margin: 0; font-family: Roboto, system-ui, -apple-system, Segoe UI, Arial, sans-serif; color: var(--md-on-surface); background:#fafafa; }

    /* Top App Bar */
    .appbar{
      position: sticky; top: 0; z-index: 10;
      background: var(--md-surface);
      border-bottom: 1px solid var(--md-outline);
      padding: 10px 16px;
      display: flex; align-items: center; gap: 12px;
    }
    .appbar .title { font-size: 18px; font-weight: 600; margin: 0; display:flex; align-items:center; gap:8px; }
    .toolbar { margin-left: auto; display: flex; gap: 8px; flex-wrap: wrap; }

    /* Layout */
    #app { display: grid; grid-template-columns: 1fr 360px; height: calc(100vh - 56px); }
    #canvas { background: #fafafa; }

    /* GÃ¶r sjÃ¤lva viewer-ytan lite mer "kort"-kÃ¤nsla */
    .djs-container{
      background:
        linear-gradient(0deg, #fff, #fff) padding-box,
        repeating-linear-gradient(0deg, #f9fafb, #f9fafb 20px, #ffffff 20px, #ffffff 40px) border-box;
      border-left: 1px solid var(--md-outline);
    }

    /* Side panel (card) */
    #side {
      background: var(--md-surface);
      border-left: 1px solid var(--md-outline);
      display: flex; flex-direction: column; height: 100%;
    }
    .card-header{ padding: 14px 16px; border-bottom:1px solid var(--md-outline); display:flex; align-items:center; gap:8px; }
    .card-content{ padding: 12px 16px; overflow: auto; display: flex; flex-direction: column; gap: 12px; }

    /* Inputs & buttons */
    .field { display: grid; gap: 6px; }
    .label { font-size: 12px; color:#374151; font-weight: 600; }
    .row { display:flex; gap:8px; flex-wrap: wrap; }
    input[type="text"]{
      width: 100%; padding: 10px 12px; border:1px solid var(--md-outline); border-radius: 12px; outline: none; background:#fff;
      font-size: 14px;
    }
    .btn{
      border:1px solid var(--md-outline); background:#fff; border-radius:12px; padding:8px 12px; cursor:pointer; font-size:14px;
      display:inline-flex; align-items:center; gap:6px;
    }
    .btn:hover{ background:#f3f4f6; }
    .btn-primary{ border-color: transparent; background: var(--md-primary); color:#fff; }
    .btn-primary:hover{ filter: brightness(0.96); }

    /* Info list */
    .kv { display:grid; grid-template-columns: 110px 1fr; gap:6px 10px; align-items: baseline; }
    .k { color:#374151; font-weight:600; font-size: 13px; }
    .v { font-size: 14px; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }

    /* Tags / chips */
    .chip { display:inline-flex; gap:6px; padding:4px 8px; border-radius: 999px; font-size:12px; background: var(--md-surface-variant); }

    /* Links */
    a { color: var(--md-primary); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* BPMN highlight */
    .highlight > .djs-outline { stroke: var(--md-danger) !important; stroke-width: 2px !important; }
    .highlight > .djs-visual > :nth-child(1) { stroke: var(--md-danger) !important; }
  </style>
</head>
<body>
  <!-- Top bar -->
  <div class="appbar">
    <h1 class="title">
      <span class="material-symbols-rounded" style="font-size:20px;">schema</span>
      CI Test â€” BPMN Viewer
    </h1>
    <div class="toolbar">
      <a class="btn" href="reports/coverage/" target="_blank" rel="noopener">
        <span class="material-symbols-rounded" style="font-size:18px;">table</span>
        Visa testrapport
      </a>
      <button id="btn-zoom-in" class="btn" title="Zooma in">
        <span class="material-symbols-rounded" style="font-size:18px;">zoom_in</span> Zoom +
      </button>
      <button id="btn-zoom-out" class="btn" title="Zooma ut">
        <span class="material-symbols-rounded" style="font-size:18px;">zoom_out</span> Zoom âˆ’
      </button>
      <button id="btn-reset" class="btn" title="Fit to viewport">
        <span class="material-symbols-rounded" style="font-size:18px;">center_focus_strong</span> Fit
      </button>
    </div>
  </div>

  <div id="app">
    <div id="canvas"></div>

    <aside id="side">
      <div class="card-header">
        <span class="material-symbols-rounded" style="font-size:20px;">info</span>
        <div style="font-weight:600;">Detaljer</div>
      </div>
      <div class="card-content">
        <div class="field">
          <div class="label">GÃ¥ till element-ID</div>
          <div class="row">
            <input id="elInput" type="text" placeholder="t.ex. Activity_11wac6l" />
            <button id="btn-go" class="btn-primary"><span class="material-symbols-rounded" style="font-size:18px;">arrow_forward</span> Markera</button>
            <button id="btn-clear" class="btn"><span class="material-symbols-rounded" style="font-size:18px;">close</span> Rensa</button>
          </div>
          <div style="color:#6b7280; font-size:12px;">Tips: anvÃ¤nd ocksÃ¥ <code>?el=&lt;elementId&gt;</code> i URL:en.</div>
        </div>

        <div class="kv">
          <div class="k">Valt element:</div> <div class="v mono" id="selId">â€“</div>
          <div class="k">Typ:</div>           <div class="v" id="selType">â€“</div>
          <div class="k">Namn:</div>          <div class="v" id="selName">â€“</div>
        </div>

        <hr style="border:none; border-top:1px solid var(--md-outline);">

        <div>
          <div class="label" style="margin-bottom:6px;">SnabblÃ¤nkar</div>
          <div id="links"><small>VÃ¤lj ett element fÃ¶r att generera lÃ¤nkar (Jira, Playwright, Figma) baserat pÃ¥ BPMN-ID och meta.</small></div>
        </div>
      </div>
    </aside>
  </div>

  <!-- bpmn-js viewer -->
  <script src="https://unpkg.com/bpmn-js/dist/bpmn-navigated-viewer.development.js"></script>
  <script>
    // === Konfiguration ===
    const RAW_BPMN_PATH = 'ci_test.bpmn';
    const BPMN_PATH = new URL(RAW_BPMN_PATH, window.location.href).toString() + `?v=${Date.now()}`;

    // Repo-konfig fÃ¶r lÃ¤nkar
    const GH_OWNER = 'mangepang';
    const GH_REPO  = 'test_ci';
    const GH_BRANCH = 'main';

    // BaslÃ¤nkar
    const JIRA_BASE_QUERY = 'https://jira.example.com/issues/?jql='; // Jira-sÃ¶k (byt till er)
    const PLAYWRIGHT_CODE_SEARCH = `https://github.com/${GH_OWNER}/${GH_REPO}/search?q=`;
    const PLAYWRIGHT_FILE_BASE   = `https://github.com/${GH_OWNER}/${GH_REPO}/blob/${GH_BRANCH}/`;

    // Figma (om full URL saknas i BPMN)
    const FIGMA_FILE_KEY = ''; // sÃ¤tt t.ex. 'iSRYo9n5XbWcTuqPjAxMMZ' om du vill bygga via node-id

    const viewer = new BpmnJS({ container: '#canvas', height: '100%' });

    // ===== Helpers fÃ¶r parsing & rendering =====
    const metaById = new Map();
    const ln = (tagName) => (tagName || '').split(':').pop();
    const text = (el) => (el && (el.textContent || '').trim()) || '';
    const toList = (val) => (val || '').split(/[,|]/).map(s => s.trim()).filter(Boolean);

    function buildMetaIndex(xmlString) {
      const dom = new DOMParser().parseFromString(xmlString, 'text/xml');
      const elWithExt = dom.querySelectorAll('*[id] > bpmn\\:extensionElements, *[id] > extensionElements');

      elWithExt.forEach(ext => {
        const parent = ext.parentNode;
        const id = parent.getAttribute('id');
        if (!id) return;

        const meta = {
          playwrightRefs: [],
          jiraKeys: [],
          tags: [],
          priority: '',
          figmaUrl: '',
          figmaNodeId: '',
          figmaComponentKey: '',
          variant: ''
        };

        Array.from(ext.children || []).forEach(child => {
          Array.from(child.children || []).forEach(kv => {
            const name = ln(kv.tagName);
            const val = text(kv);
            switch (name) {
              case 'playwrightRef':   meta.playwrightRefs.push(val); break;
              case 'jiraKeys':        meta.jiraKeys.push(...toList(val)); break;
              case 'tags':            meta.tags.push(...toList(val)); break;
              case 'priority':        meta.priority = val; break;
              case 'figmaUrl':        meta.figmaUrl = val; break;
              case 'figmaNodeId':     meta.figmaNodeId = val; break;
              case 'figmaComponentKey': meta.figmaComponentKey = val; break;
              case 'variant':         meta.variant = val; break;
              default: /* ignore */ ;
            }
          });
        });

        metaById.set(id, meta);
      });
    }

    function buildFigmaUrl(meta) {
      if (meta.figmaUrl) return meta.figmaUrl;
      if (FIGMA_FILE_KEY && meta.figmaNodeId) {
        return `https://www.figma.com/file/${FIGMA_FILE_KEY}?node-id=${encodeURIComponent(meta.figmaNodeId)}`;
      }
      return '';
    }

    // ===== UI helpers =====
    const getParam = (name) => new URLSearchParams(window.location.search).get(name);
    function addMarker(elementId) {
      try {
        const canvas = viewer.get('canvas');
        canvas.addMarker(elementId, 'highlight');
        canvas.zoom('fit-viewport', 'auto');
        canvas.scrollToElement(elementId);
      } catch {}
    }
    function clearMarkers() {
      const canvas = viewer.get('canvas');
      const elementRegistry = viewer.get('elementRegistry');
      elementRegistry.getAll().forEach(el => canvas.removeMarker(el.id, 'highlight'));
    }

    function setSelected(el) {
      const links = document.getElementById('links');
      const idEl = document.getElementById('selId');
      const typeEl = document.getElementById('selType');
      const nameEl = document.getElementById('selName');

      idEl.textContent   = el?.id ?? 'â€“';
      typeEl.textContent = el?.type ?? 'â€“';
      nameEl.textContent = el?.businessObject?.name ?? 'â€“';

      links.innerHTML = '';
      if (!el) {
        links.innerHTML = '<small>VÃ¤lj ett element fÃ¶r att generera lÃ¤nkar.</small>';
        return;
      }

      const elId = el.id;
      const meta = metaById.get(elId) || {};

      // â€” Playwright: direkta refs + repo-sÃ¶k pÃ¥ [bpmn:ID]
      if (meta.playwrightRefs && meta.playwrightRefs.length) {
        const h = document.createElement('div');
        h.innerHTML = '<div class="label">Playwright</div>';
        links.appendChild(h);

        meta.playwrightRefs.forEach(ref => {
          const [path, title] = String(ref).split('#');
          const safePath = (path || '').replace(/^\/+/, '');
          const fileUrl = PLAYWRIGHT_FILE_BASE + encodeURI(safePath);
          const aFile = document.createElement('a');
          aFile.href = fileUrl;
          aFile.target = '_blank'; aFile.rel = 'noopener';
          aFile.textContent = `ðŸ“„ ${safePath}${title ? ` â€” ${title}` : ''}`;
          links.appendChild(aFile);
          links.appendChild(document.createElement('br'));
        });
      }
      const q = `path:tests "[bpmn:${elId}]"`;
      const codeSearch = document.createElement('a');
      codeSearch.href = `${PLAYWRIGHT_CODE_SEARCH}${encodeURIComponent(q)}&type=code`;
      codeSearch.target = '_blank'; codeSearch.rel = 'noopener';
      codeSearch.textContent = 'ðŸ”Ž SÃ¶k [bpmn:ID] i testkoden';
      links.appendChild(codeSearch);
      links.appendChild(document.createElement('br'));

      // â€” Jira: direkta nycklar + fallback sÃ¶k
      if (meta.jiraKeys && meta.jiraKeys.length) {
        const h = document.createElement('div');
        h.innerHTML = '<div class="label" style="margin-top:6px;">Jira</div>';
        links.appendChild(h);
        meta.jiraKeys.forEach(key => {
          const a = document.createElement('a');
          a.href = `https://jira.example.com/browse/${encodeURIComponent(key)}`;
          a.target = '_blank'; a.rel = 'noopener';
          a.textContent = `ðŸ”— ${key}`;
          links.appendChild(a);
          links.appendChild(document.createElement('br'));
        });
      }
      const jiraSearch = document.createElement('a');
      jiraSearch.href = JIRA_BASE_QUERY + encodeURIComponent(`text ~ "${elId}" OR "BPMN Element ID" ~ "${elId}"`);
      jiraSearch.target = '_blank'; jiraSearch.rel = 'noopener';
      jiraSearch.textContent = 'ðŸ”Ž SÃ¶k Ã¤renden kopplade till ID';
      links.appendChild(jiraSearch);
      links.appendChild(document.createElement('br'));

      // â€” Figma
      const figmaResolved = buildFigmaUrl(meta);
      if (figmaResolved) {
        const h = document.createElement('div');
        h.innerHTML = '<div class="label" style="margin-top:6px;">Figma</div>';
        links.appendChild(h);

        const a = document.createElement('a');
        a.href = figmaResolved;
        a.target = '_blank'; a.rel = 'noopener';
        a.textContent = 'ðŸŽ¨ Ã–ppna relaterad Figma-skÃ¤rm';
        links.appendChild(a);
        links.appendChild(document.createElement('br'));

        if (meta.variant) {
          const v = document.createElement('div');
          v.innerHTML = `<small>Variant: <code>${meta.variant}</code></small>`;
          links.appendChild(v);
        }
      }

      // â€” Chips (taggar/prio)
      const chips = [];
      if (meta.priority) chips.push(`<span class="chip">Prio: ${meta.priority}</span>`);
      if (meta.tags && meta.tags.length) chips.push(`<span class="chip">Taggar: ${meta.tags.join(', ')}</span>`);
      if (chips.length) {
        const c = document.createElement('div');
        c.style.marginTop = '6px';
        c.innerHTML = chips.join(' ');
        links.appendChild(c);
      }
    }

    // ===== Ladda BPMN & koppla UI =====
    fetch(BPMN_PATH, { cache: 'no-store' })
      .then(async (r) => {
        if (!r.ok) throw new Error(`HTTP ${r.status} for ${r.url}`);
        const xml = await r.text();

        buildMetaIndex(xml);
        await viewer.importXML(xml);

        const canvas = viewer.get('canvas');
        const eventBus = viewer.get('eventBus');
        const elementRegistry = viewer.get('elementRegistry');

        canvas.zoom('fit-viewport', 'auto');

        // URL-param: ?el=<id>
        const elParam = getParam('el');
        if (elParam) {
          const exists = elementRegistry.get(elParam);
          if (exists) {
            addMarker(elParam);
            setSelected(exists);
            document.getElementById('elInput').value = elParam;
          }
        }

        // Klick-select
        eventBus.on('element.click', (e) => {
          const { element } = e;
          clearMarkers();
          addMarker(element.id);
          setSelected(element);
          history.replaceState(null, '', `?el=${encodeURIComponent(element.id)}`);
        });

        // Topbar-knappar
        document.getElementById('btn-zoom-in').onclick  = () => canvas.zoom(canvas.zoom() + 0.2);
        document.getElementById('btn-zoom-out').onclick = () => canvas.zoom(canvas.zoom() - 0.2);
        document.getElementById('btn-reset').onclick    = () => canvas.zoom('fit-viewport', 'auto');

        // GÃ¥ till / Rensa
        document.getElementById('btn-go').onclick = () => {
          const id = document.getElementById('elInput').value.trim();
          if (!id) return;
          const el = elementRegistry.get(id);
          if (el) {
            clearMarkers();
            addMarker(id);
            setSelected(el);
            history.replaceState(null, '', `?el=${encodeURIComponent(id)}`);
          } else {
            alert('Elementet hittades inte i modellen.');
          }
        };
        document.getElementById('btn-clear').onclick = () => {
          clearMarkers();
          setSelected(null);
          history.replaceState(null, '', location.pathname);
          document.getElementById('elInput').value = '';
        };
      })
      .catch(err => {
        console.error('Fel vid laddning av BPMN:', err);
        alert(`Kunde inte ladda BPMN-filen.\n${err.message}\n\nKolla att filen finns pÃ¥:\n${RAW_BPMN_PATH}`);
      });
  </script>
</body>
</html>
